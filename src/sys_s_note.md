# System S 笔记

> 感谢 [@千里冰封](https://ice1000.org/) 提供的 [原始论文](http://homepage.divms.uiowa.edu/~astump/papers/fu-stump-rta-tlca-14.pdf)
>
> 这并不是一篇关于 System S 的教程，只是一些关于学到了啥，还有啥不懂的笔记

简单来说 System S 就是在 System Fω 的基础上增加了一些 DT 性质和一个叫 Self Type 的巧妙东西用来构造数据结构，并且 System S 所加的特性都可以被擦除成 System Fω。

## Syntax

有些地方为了方便输入用的是自己定的符号

```
Term    t ::= x | x => t | t t'

Types   T ::= X | {X : k} -> T | (x : T) -> T |
              {x : T} -> T' | Self x. T | T t |
              X => T' | x => T | T T'

Kinds   k ::= * | (x : T) -> k | (X : k) -> k'

Context Γ ::= · | Γ, x : T | Γ, X : k | Γ, μ

Closure μ ::= # | μ, (x : T) :-> t | μ, (X : k) :-> T
```

## `Pi` 和  `Forall`

Types 中的 `{X : T} -> T'` 在原论文中是 `Forall X : T. T'` 而 `(X : T) -> T'` 在原论文中是 `Pi X : T. T'`，这名字就取得非常迷惑，按照常识来说 `Forall` 和 `Pi` 不应该是同一个东西么？而且这两个玩意有着一条可以说是一模一样的 Kinding rule ：

```
Γ |- T : *    Γ, x : T |- T' : *
--------------------------------
Γ |- (X : T) -> T' : *

Γ |- T : *    Γ, x : T |- T' : *
--------------------------------
Γ |- {X : T} -> T' : *
```

这更是让我迷惑了半天，同时我注意到论文中所有的 `Abstraction` 的类型都是 `Pi` 而 `Forall` 始终没出现：

```
Γ |- x : T    Γ, x : T |- t : T'
--------------------------------
Γ |- x => t : (x : T) -> T'

Γ |- x : T    Γ, x : T |- T' : k
--------------------------------
Γ |- x => T' : (x : T) -> k

Γ |- X : k    Γ, X : k |- T : k'
--------------------------------
Γ |- X => T : (X : k) -> k'
```

这么看来 `Pi` 的作用和 System Fω 里面是一样的，非常符合常识。那么问题就出现在 `Forall` 上了，它是干啥子的呢？

`Forall` 的引入和消去规则在论文中是这样的：

```
Γ |- T : *    Γ, x : T |- t : T'    x !in FV(t)
----------------------------------------------- Ind x
Γ |- t : {x : T} -> T'

Γ |- t : {x : T} -> T'    Γ |- t' : T
------------------------------------- De x
Γ |- t : [t'/x]T'
```

就是说这个 `t : {x : T} -> T'` 中的 `x` 根本不在 `t` 中出现，只会在 `T'` 中出现，所以 `Forall` 中的 `x` 并不参与运算，只是个类型标注，可以在 tyck 以后被直接擦除。这也是 System S 类型擦除的关键，类型不依赖参与运算的变量。

而且由消去规则可知 `{x : T} -> T'` 并不能手动指定参数，只能靠编译器的推导来得到参数，也就是一个类似于强制隐式参数的函数类型一样。

至于 `{X : k} -> T` 也是类似的，在原文是 `Forall X : k. T` ，是一个参数为类型的隐式参数函数类型，同样也是在 tyck 以后需要擦除的。

## Self Type

Types 中有个 `Self x. T` ，也就是这张纸最奇妙的东西， Self Type 。按照命名可以得知这是个可以包含自己的类型，也就是 `x : T(x)` 。值的类型可以包含值本身，同时我们也可也从类型的定义中反过来得出值是啥，具体细节还是看后文的例子，这里先给出 rules 。

```
Γ, x :  |- 

Γ |- t : [t/x]T    Γ |- Self x. T : *
------------------------------------- Self Gen
Γ |- t : Self x. T

Γ |- t : Self x. T
------------------ Self Inst
Γ |- t : [t/x]T
```
